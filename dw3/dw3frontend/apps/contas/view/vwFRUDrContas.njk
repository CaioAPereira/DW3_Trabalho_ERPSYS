{% extends "templates/base.html" %}

{% block content %}
<div x-data="contaForm()">
  <ol class="breadcrumb mb-2">
    <li class="breadcrumb-item active">{{ title }}</li>
  </ol>

  <div class="card">
    <div class="card-header">
      Atualização de Conta
    </div>

    <div class="card-body">
      <form>
        <!-- Linha 1: Valor + Descrição -->
        <div class="row align-items-end mb-3">
          <div class="col-md-3">
            <label for="valor" class="form-label">Valor (R$)</label>
            <input type="number" step="0.01" class="form-control" id="valor"
                   x-model="form.valor" required x-bind:disabled="disabled">
          </div>

          <div class="col-md-9">
            <label for="descricao" class="form-label">Descrição</label>
            <input type="text" class="form-control" id="descricao"
                   x-model="form.descricao" required x-bind:disabled="disabled">
          </div>
        </div>

        <!-- Linha 2: Datas -->
        <div class="row align-items-end mb-3">
          <div class="col-md-6">
            <label for="dtavencimento" class="form-label">Data de Vencimento</label>
            <input type="date" class="form-control" id="dtavencimento"
                   x-model="form.dtavencimento" x-bind:disabled="disabled">
          </div>

          <div class="col-md-6">
            <label for="dtarecebimento" class="form-label">Data de Recebimento</label>
            <input type="date" class="form-control" id="dtarecebimento"
                   x-model="form.dtarecebimento" x-bind:disabled="disabled">
          </div>
        </div>

        <!-- Linha 3: Cliente -->
        <div class="row mb-4">
          <div class="col-md-12">
            <label for="clienteid" class="form-label">Cliente</label>
            <select class="form-select" id="clienteid"
                    x-model="form.clienteid" x-bind:disabled="disabled" name="clienteid">
              <option value="">Cliente Excluído</option>
              {% for cli in clientes %}
              <option value="{{ cli.clienteid }}" {% if data.clienteid == cli.clienteid %}selected{% endif %}>
                {{ cli.nomerazaosocial }}
              </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Botões -->
        <div class="d-flex gap-2">
          <button type="button" @click="updateForm()" class="btn btn-primary" x-show="!disabled">Salvar</button>
          <button type="button" @click="deleteForm()" class="btn btn-danger" x-show="!disabled">Excluir Conta</button>
          <a href="/contas/manutContas" class="btn btn-info text-white">Retornar</a>
        </div>
      </form>

      <!-- Mensagem de retorno -->
      <div class="mt-3">
        <template x-if="message">
          <div :class="messageClass" x-text="message"></div>
        </template>
      </div>
    </div>
  </div>
</div>

<script>
  window.onload = function () {
    windowOnLoad();
    const localErro = "{{erro}}";
    if (localErro != "") {
      alert("[vwContas|onload] Servidor retornou o erro: " + localErro);
    }
    $("#valor").focus();
  };

  function contaForm() {
    return {
      form: {
        contasid: "{{data.contasid}}",
        valor: "{{data.valor}}",
        descricao: "{{data.descricao}}",
        dtavencimento: "{{data.dtavencimento}}",
        dtarecebimento: "{{data.dtarecebimento}}",
        clienteid: "{{data.clienteid}}",
        removido: {{data.removido | dump | safe }}
      },
      message: '',
      messageClass: '',
      disabled: {{disabled}},

      async updateForm() {
        try {
          const response = await fetch('/contas/UpdateContas', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.form)
          });
          const result = await response.json();
          if (result.status == "ok") {
            alert("Conta atualizada com sucesso!");
            window.location.href = "/contas/manutContas";
          } else {
            this.message = `Erro! Não foi possível atualizar a conta: ${result.msg}`;
            this.messageClass = 'alert alert-danger';
          }
        } catch (error) {
          this.message = `Erro de conexão: ${error.message}`;
          this.messageClass = 'alert alert-danger';
        }
      },

      async deleteForm() {
        try {
          const response = await fetch('/contas/DeleteContas', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(this.form)
          });
          const result = await response.json();
          if (result.status == "ok") {
            alert("Conta excluída com sucesso!");
            window.location.href = "/contas/manutContas";
          } else {
            this.message = `Erro! Não foi possível excluir a conta: ${result.msg}`;
            this.messageClass = 'alert alert-danger';
          }
        } catch (error) {
          this.message = `Erro de conexão: ${error.message}`;
          this.messageClass = 'alert alert-danger';
        }
      }
    };
  }
</script>
{% endblock %}
